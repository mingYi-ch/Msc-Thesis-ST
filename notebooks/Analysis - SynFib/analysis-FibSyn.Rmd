---
title: "R Notebook"
---

# Library

```{r}
library(tidyverse)
library(SingleCellExperiment)
library(lemur)
library(SpatialExperiment)
library(patchwork)

library(boot)
library(Seurat)
library(tidyr) 
library(qs) 
library(glue) 
library(splines)
```

```{r}
source("../../src/util.R")
source("../../config/config.R")
```

# Load data

```{r}
res.dir <- get.res.dir()
res.dir.LEMUR <- file.path(get.res.dir(), "LEMUR")

# fit <- qs::qread(file.path(res.dir.LEMUR, "fit_small.qs"))
fit <- qs::qread(file.path(res.dir.LEMUR, "fit.qs"))

# nei <- qs::qread(file.path(res.dir.LEMUR, "nei_small.qs"))
nei_all <- qs::qread(file.path(res.dir.LEMUR, "nei.qs"))

spe <- qs::qread(file.path(res.dir.LEMUR, "se_dist.qs"))
spe
```

```{r}
# splineTimeR
diffExprs <- qread(file.path(res.dir, "diffExprs_spline.qs"))
target.genes <- c(diffExprs$genes[1:3], "THY1")

nei <- nei_all %>% filter(name %in% target.genes)
nei

marker.sel <- "VWF&PECAM1"
target.cell <- "ECs"

filename <- glue("ECs_manually_marker_final.qs")
is.ec.spot <- qread(file.path(res.dir, "deconvolution", filename))

# Kruskal-Wallis test
num_genes <- 500
pvals <- qread(file.path(res.dir, glue("pvals_kruskal_test_{num_genes}.qs")))


which.min(pvals)

which(pvals >= 0.05 & pvals <= 0.1)

which.max(pvals)

max(pvals, na.rm = T)
sum(pvals < 0.05, na.rm = T)
```

# Analysis

```{r}
marker.genes <- qread(file.path(res.dir, "markers.qs"))
markers.SynFib <- marker.genes %>% 
              filter(cluster == "SynFib") %>%
              filter(pct.1 > 0.25 & pct.2 >= 0 & avg_log2FC >= 0.5) %>%  # Marlia
              top_n(n = 200, wt = avg_log2FC) %>% 
              pull(gene)

"THY1" %in% markers.SynFib
```

```{r}
nei <- nei_all %>% filter(name %in% markers.SynFib)
idx <- nei$sel_statistic %>% which.min()
nei$name[idx]

gene_of_interest <- markers.SynFib %>% sample(1)
gene_of_interest <- markers.SynFib[1]
gene_of_interest <- "COL3A1" #X
gene_of_interest <- "BGN"
gene_of_interest <- "THY1"
gene_of_interest <- "PRG4"
gene_of_interest <- "HTRA1"

P.Val <- NA
if (gene_of_interest %in% names(pvals) ) {
  P.Val <- pvals[[gene_of_interest]]
  P.Val <- round(P.Val, 3)
}

stat <- "mean"
```

## Dist plot of all pixels

```{r}
expr <-  counts(spe)[gene_of_interest,]
expr <- as.data.frame(expr)
expr <- as.numeric(unlist(expr))
table(expr)

expr_comparison_scatter <- as_tibble(colData(spe)) %>%
  mutate(dist.cluster = ordered(dist.cluster, levels = levels(spe$dist.cluster))) %>%
  mutate(expr = expr) %>%
  filter(!is.null(expr)) %>% 
  ggplot(aes(x = dist.cluster, y = expr, fill = dist.cluster)) +
    geom_violin(trim = FALSE) +
    # scale_y_continuous(limits = c(0, 10), expand = expansion(add = 0)) +
    guides(x = guide_axis(angle = 45)) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(color = "", y = "Expression",
         subtitle = paste0("All pixels - ", " expr. vs. Dist to endothelial cell"))  +
    theme(plot.subtitle = element_text(size = 7))

expr_comparison_scatter
```

```{r}
res.dir <- get.res.dir()
filename <- paste0("Violin plot of dists",  ".png")
ggsave(filename = file.path(res.dir, "plots", filename), plot = expr_comparison_scatter, device = "png", width = 10, height = 8, dpi = 500)
```

```{r}
expr <-  counts(spe)[gene_of_interest,]
expr <- as.data.frame(expr)
expr <- as.numeric(unlist(expr))
table(expr)

expr_comparison_scatter <- as_tibble(colData(spe)) %>%
  mutate(dist.cluster = ordered(dist.cluster, levels = levels(spe$dist.cluster))) %>%
  mutate(expr = expr) %>%
  filter(!is.null(expr)) %>% 
  ggplot(aes(x = dist.cluster, y = expr, fill = dist.cluster)) +
    geom_boxplot(alpha = 0.3) + # Add boxplots for reference
    stat_summary(
      fun = function(x) quantile(x, probs = 0.75), 
      geom = "point", 
      shape = 23, 
      size = 3, 
      fill = "red", 
      color = "black"
    ) + 
    scale_y_continuous(limits = c(0, 20), expand = expansion(add = 0)) +
    guides(x = guide_axis(angle = 45)) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(color = "", y = "Expression",
         subtitle = paste0("All pixels - ", " expr. vs. Dist to endothelial cell"))  +
    theme(plot.subtitle = element_text(size = 7))

expr_comparison_scatter
```

```{r}
expr <-  counts(spe)[gene_of_interest,]
expr <- as.data.frame(expr)
expr <- as.numeric(unlist(expr))
table(expr)

expr_comparison_scatter <- as_tibble(colData(spe)) %>%
  mutate(expr = expr) %>%
  ggplot(aes(x = min.dists, y = expr)) +
    geom_point(size = 1) +
    scale_y_continuous(limits = c(0, 20), expand = expansion(add = 0)) +
    guides(x = guide_axis(angle = 45)) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(color = "", y = "Expression",
         subtitle = paste0("All pixels - ", " expr. vs. Dist to endothelial cell"))  +
    theme(plot.subtitle = element_text(size = 7))

expr_comparison_scatter
```

## Dist Clusters in UMAP

```{r}
umap <- reducedDim(spe, "umap_sel")
```

```{r}
as_tibble(colData(fit)) %>%
  mutate(umap = umap[colnames(fit),]) %>%
  ggplot(aes(x = umap[,1], y = umap[,2])) +
    geom_point(aes(color = dist.cluster), size = 0.7, stroke = 0) +
    guides(color = guide_legend(override.aes = list(size = 1)))
```

## DE matrix in UMAP

```{r}
DE <- assay(fit, "DE") 
DE_seurat <- CreateSeuratObject(counts = DE, data = DE) %>% 
  # NormalizeData(verbose = FALSE) %>%
  # FindVariableFeatures(selection.method = "vst", nfeatures = 2000) %>%
  ScaleData(verbose = FALSE) %>%
  RunPCA(features = rownames(.), verbose = FALSE) %>% 
  FindNeighbors(reduction = "pca", dims = 1:20) %>% 
  FindClusters(verbose = FALSE, resolution = 0.2) %>% 
  RunUMAP(reduction = "pca", dims = 1:20)
  
```

```{r}
p1 <- DimPlot(DE_seurat, reduction = "umap", label = TRUE, pt.size = 0.1)
p1
# p2 <- SpatialDimPlot(DE_seurat, label = TRUE, label.size = 3)
# p1.2 <- p1 + p2
```

## Correlation plot

```{r}
expr_comparison_pl <- lemur_curve_plot(nei, fit,  gene_of_interest, spe, stat_func_mean)
expr_comparison_pl
```

```{r}
filename <- paste0("correlation plot of dists - bootstrap mean",  ".svg")
ggsave(filename = file.path(res.dir, "plots", filename), plot = expr_comparison_pl, device = "svg", width = 10, height = 8, dpi = 700)
```

```{r}
# expr_comparison_violin <- comparison_data %>%
#   mutate(dist.cluster = ordered(dist.cluster, levels = levels(fit$colData$dist.cluster))) %>% 
#   ggplot(aes(x = dist.cluster, y = expr)) +
#     geom_violin(aes(fill = origin), trim = F) +
#     scale_fill_manual(values = c("inside" = "black", "outside" = "lightgrey"), labels = c("inside" = "pixels in neighborhood", "outside" = "All other pixels")) +
#     scale_y_continuous(limits = c(y_min, y_max), expand = expansion(add = y_expansion)) +
#     guides(x = guide_axis(angle = 45)) +
#     theme(axis.title.x = element_blank(), legend.position = "bottom") +
#     labs(color = "", y = "Expression (log transformed)",
#          subtitle = paste0(gene_of_interest, " expr. vs. Dist to endothelial cell - bootstrapped mean"))  +
#     theme(plot.subtitle = element_text(size = 7))
# 
# expr_comparison_violin
# 
# filename <- paste0("expr_comparison_violin",  ".png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = expr_comparison_violin, device = "png", width = 10, height = 8, dpi = 700)
```

```{r}
# expr_comparison_scatter <- comparison_data %>%
#   mutate(dist.cluster = ordered(dist.cluster, levels = levels(fit$colData$dist.cluster))) %>% 
#   ggplot(aes(x = dist.cluster, y = expr)) +
#     geom_point(aes(color = origin), size = 1) +
#     # geom_smooth(aes(color = origin, x = as.integer(dist.cluster)), span = 1.5, spe = FALSE, linewidth = 2) +
#     scale_color_manual(values = c("inside" = "black", "outside" = "lightgrey"), labels = c("inside" = "pixels in neighborhood", "outside" = "All other pixels")) +
#     scale_y_continuous(expand = expansion(add = 0)) +
#     guides(x = guide_axis(angle = 45)) +
#     theme(axis.title.x = element_blank(), legend.position = "bottom") +
#     labs(color = "", y = "Expression",
#          subtitle = paste0(gene_of_interest, " expr. vs. Dist to endothelial cell"))  +
#     theme(plot.subtitle = element_text(size = 7))
# 
# expr_comparison_scatter
```

```{r}
# filename <- paste0("correlation plot of dists_scatter",  ".png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = expr_comparison_scatter, device = "png", width = 10, height = 8, dpi = 500)
```

```{r, paged.print=FALSE}
is_inside <- tibble(symbol = gene_of_interest, cell_id = list(colnames(fit))) %>%
  left_join(dplyr::select(nei, name, neighborhood), by = c("symbol"= "name")) %>%
  mutate(inside = map2(cell_id, neighborhood, \(ref, nei_pixels) ref %in% nei_pixels)) %>%
  dplyr::select(-neighborhood) %>%
  unnest(c(inside, cell_id))

```

```{r}
qs::qsave(is_inside, file.path(res.dir, "is_inside.qs"))

```

## UMAP DE

```{r}
# predicted DE
de_plot_data <- as_tibble(colData(fit), rownames = "cell_id") %>%
  mutate(umap = umap[colnames(fit),]) %>%
  mutate(de = as_tibble(t(assay(fit[gene_of_interest,], "DE")))) %>%
  unnest(de, names_sep = "-") %>%
  pivot_longer(starts_with("de-"), names_sep = "-", values_to = "de", names_to = c(NA, "symbol")) %>%
  inner_join(is_inside, by = c("symbol", "cell_id")) %>%
  sample_frac(size = 1)

abs_max <- max(abs(quantile(de_plot_data$de, c(0.95, 0.05))))

dist_de_pl <- de_plot_data %>%
  mutate(inside = ifelse(inside, "in", "out")) %>%
  mutate(inside = factor(inside, levels = c("in", "out")))  %>%
  ggplot(aes(x = umap[,2], y = umap[,1])) +
    ggrastr::rasterise(geom_point(aes(color = de), size = 0.5, stroke = 0), dpi = 600) +
    # scale_colour_gradient2_rev(limits = c(-1, 1) * abs_max, oob = scales::squish, breaks = c(-1, 0, 1) * signif_to_zero(abs_max, 1), mid = "lightgrey") +
    scale_color_de_gradient(abs_max, mid_width = 0.2) +
    facet_grid(vars(inside), labeller = labeller(inside = as_labeller(c("in" = "pixels in Neighb.", "out" = "All other pixels"))),
               switch="y") +
    small_axis("", fontsize = font_size_small) +
    theme(legend.position = "bottom", legend.margin = margin(t = -2, unit = "mm")) +
    guides(color = guide_colorbar(barheight = unit(1, "mm"), barwidth = unit(15, "mm"), title.vjust = 1)) +
    labs(color = "$\\Delta$")

dist_de_pl
```

```{r}
# filename <- paste0("UMAP_DE",  ".png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = dist_de_pl, device = "png", width = 10, height = 14, dpi = 800)
```

```{r, paged.print=FALSE}
# calculate the frac inside origin group!!
rel_plt <- colData(fit) %>%
  as_tibble(rownames = "cell_id") %>%
  left_join(is_inside) %>%
  dplyr::count(dist.cluster, symbol, inside) %>%
  mutate(frac = n / sum(n), .by = c(symbol, inside)) %>%  # calculate the frac inside origin group!!
  mutate(dist.cluster = fct_relabel(dist.cluster, \(x) str_replace(x, ",", ", "))) %>%
  ggplot(aes(x = dist.cluster, y = frac)) +
    geom_col(aes(fill = inside), position = position_dodge2()) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
    scale_x_discrete(position = "top") +
    scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "lightgrey")) +
    guides(x = guide_axis(angle = 90)) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(color = "", y = "Rel. No. pixels - Group-Wise Fractions")

rel_plt 

# calculate the frac overall: divide by total amount of spots
rel_plt_2 <- colData(fit) %>%
  as_tibble(rownames = "cell_id") %>%
  left_join(is_inside) %>%
  dplyr::count(dist.cluster, symbol, inside) %>%
  mutate(total_n = sum(n), .by = symbol) %>%  # Calculate total count per symbol
  mutate(frac = n / total_n, .by = c(symbol, inside)) %>%  # calculate the frac inside origin group!!
  mutate(dist.cluster = fct_relabel(dist.cluster, \(x) str_replace(x, ",", ", "))) %>%
  ggplot(aes(x = dist.cluster, y = frac)) +
    geom_col(aes(fill = inside), position = position_dodge2()) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
    scale_x_discrete(position = "top") +
    scale_fill_manual(values = c("TRUE" = "black", "FALSE" = "lightgrey")) +
    guides(x = guide_axis(angle = 90)) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(color = "", y = "Rel. No. pixels - Overall Fractions")

rel_plt_2
```

# Plot ECs and neighborhood

```{r}
plots_ECs_nei <- lemur_nei_plot(spe, nei, fit, gene_of_interest)
  
```

```{r}
filename <- paste0(info_of_interest, " vs ", "ECs from ", method,  ".svg")
ggsave(filename = file.path(res.dir, "plots", filename), plot = plots_ECs_nei, device = "svg", width = 10, height = 8)

filename <- glue("ECs and nei - {gene_of_interest}.png")

ggsave(filename = file.path(res.dir, "plots", filename), plot = plots_ECs_nei, device = "png", width = 10, height = 8, dpi = 500, bg = "white")

plots_ECs_nei
```

# Plot T cells and B cells marker

```{r}
T_marker <- "CD3D"
B_marker <- "CD19"

T_expr <- spe[T_marker,] %>% logcounts() %>% as.vector() %>% as.numeric()
B_expr <- spe[B_marker,] %>% logcounts() %>% as.vector() %>% as.numeric()
avg <- mapply(function(x, y) mean(c(x, y), na.rm = T), T_expr, B_expr)
names(avg) <- colnames(spe)

size.axis.text <- 8 * 2
size.axis.title <- 8.5 * 2
size.axis <- 7 * 2

plots_TB_avg <- as_tibble(spatialCoords(spe)) %>%
  mutate(avg.expr = avg) %>%
  ggplot(aes(x = x, y = y)) +
    geom_point(aes(fill = avg.expr), size = 0.7, alpha = 0.5, shape = 21, stroke = 0.1) + # here is the border color
    scale_fill_gradient(low = "white", high = "red")  +
    labs(subtitle = glue("avg expr.of Tcell marker {T_marker} and marker Bcell {B_marker}"),
         x = "row pixel in full resolution",
         y = "column pixel in full resolution",
         fill = glue("avg expr.of {T_marker} and {B_marker}")) + 
    
    theme(plot.subtitle = element_text(size = size.axis.title),
          legend.text = element_text(size = size.axis.text),
          legend.title = element_text(size = size.axis.text),
          axis.title.x = element_text(size = size.axis.text),
          axis.title.y = element_text(size = size.axis.text),
          axis.text.x = element_text(size = size.axis),  
          axis.text.y = element_text(size = size.axis),
          legend.position = "right ") 
plots_TB_avg
```

```{r}
filename <- paste0("plots_TB_avg.svg")
ggsave(filename = file.path(res.dir, "plots", filename), plot = plots_TB_avg, device = "svg", width = 10, height = 8)
```

## Save plot

```{r}
# plot <- expr_comparison_pl / expr_comparison_violin / rel_plt_2
# filename <- glue("coorelation plot - {gene_of_interest}.png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = plot, device = "png", width = 10, height = 14, dpi = 800,   bg = "white" # Set background to white
# )
# 
# plot
```

```{r}
# plot <- expr_comparison_original_mean_pl /rel_plt_2
# filename <- paste0("expr_comparison_original_mean_pl",  ".png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = plot, device = "png", width = 10, height = 14, dpi = 800)
# 
# plot
```

```{r}
# plot <- expr_comparison_original_mean_pl /rel_plt_2
# filename <- paste0("expr_comparison_original_mean_pl",  ".png")
# ggsave(filename = file.path(res.dir, "plots", filename), plot = plot, device = "png", width = 10, height = 14, dpi = 800)
# 
# plot
```

## Misc.
