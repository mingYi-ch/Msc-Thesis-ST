---
title: "LEMUR"
output:
  html_document:
    df_print: paged
output.width: "75%"
---

# Library

```{r}
library(Matrix)
library(ggplot2)
library(gghighlight)
library(tidyverse)

library(STdeconvolve)
library(SpatialExperiment)
library(lemur)
library(igraph)
library(qs)

library(dplyr)
# library(spacexr)
```

```{r}
source("../src/util.R")
source("../config/config.R")
```

# Load data

```{r}
set.seed(5)
```

```{r}

# path for local
data_dir <- '../data'

# path for S3IT
data_dir <- '/shares/rheumatologie.usz/caroline/spatial'
biopsy_dirs <- get.dirs(data_dir)
```

```{r}
dir <-  biopsy_dirs[["SHK166_RA_Knee"]]
spe <- load.data(dir)
spe
```

```{r}
res.dir <- get.res.dir()

# model results
deconProp <- qread(file.path(res.dir, "deconvolution/deconProp_best.qs"))

# maually by marker
is.ec.spot <- qread(file.path(res.dir, "deconvolution/ECs_manually_VWF.qs"))
is.ec.spot <- qread(file.path(res.dir, "deconvolution/ECs_manually_PECAM1.qs"))

# wether use the deconvolution model
use.model <- F
```

# Define covariate

## Proximity to a specific cell type

```{r}
pos <- spatialCoords(spe)
pos <- pos[, c('x','y')]
pos <- as.matrix(pos)
```

```{r}
# Define target cell types
if (use.model) {
  topic.target <- "2"
  prop.threshold <- 0.2
  weight <- NULL
  
  deconProp_target <- deconProp[,topic.target]
  deconProp_target <- deconProp_target[deconProp_target > prop.threshold]
  
  length(deconProp_target)
  bc.target <- names(deconProp_target)
  pos.target <-  pos[bc.target,]
  weights <- deconProp_target
  
}else{
  bc.target <- colnames(spe)[is.ec.spot$is.ec.spot]
  pos.target <-  pos[bc.target,]
  weights <- rep(1, length(bc.target))
}


```

```{r}
adjacency.matrix <- get.adjacency.matrix(pos, squared.radius = 9000)
sum(adjacency.matrix)
```

```{r}
# build a graph
g <- graph_from_adjacency_matrix(adjacency.matrix, mode = 'undirected')
components(g)$no

node_id <- 409
neighbors_node <- neighbors(g, v = node_id, mode = "all")
print(neighbors_node)

bc.idxs <- seq_along(pos[ ,1])

target.idxs <- which(rownames(pos) %in% bc.target)
setdiff(bc.target, colnames(spe)[target.idxs])
length(target.idxs)

# get all min dists to target
start_time <- Sys.time()
dists.mat <- get.all.dists(g, bc.idxs, target.idxs)
end_time <- Sys.time()

execution_time <- end_time - start_time
message("Sys.time execution time:", execution_time)

```

```{r}
min.dists <- get.min.dists(dists.mat, weights)
names(min.dists) <- colnames(spe)
spe$min.dists <- min.dists
# table(min.dists)
```

## Visualize Dists to targets

```{r}
# maually by marker
cluster <-  "Endothelial Cells"
marker.sel <- "PECAM1"

method <- paste0("Manually by marker ", marker.sel)

groups <- rep("others", ncol(spe))
names(groups) <- colnames(spe)
groups[bc.target] <- cluster

strokes <- ifelse(groups == cluster, 0.5, 0)

# Create ggplot object
plots <- as_tibble(spatialCoords(spe)) %>%
  mutate(min.dists = min.dists, groups = groups, strokes = strokes) %>%
  ggplot(aes(x = x, y = y, shape = groups, fill = min.dists)) +
  geom_point(aes(stroke = strokes), size = 2, alpha = 0.7, color = "black") +
  scale_shape_manual(values = c(24, 21)) +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = paste0("Min.Dists", " to ", "ECs from ", method),
       x = "pxl_row_in_fullres",
       y = "pxl_col_in_fullres",
       fill = paste0("Min.Dists"))

filename <- paste0("Min.Dists", " to ", "ECs from ", method,  ".svg")
ggsave(filename = file.path(res.dir, "plots", filename), plot = plots, device = "svg", width = 10, height = 8)

plots
```

# Prepare LEMUR

```{r}
# add Inf, n + 1 groups
bin.dists <- function(x, n = 5, from = min(x), to = max(x[is.finite(x)]), add_label = TRUE, label_fmt = "%.2f"){
  groups <- seq(from, to, length.out = n+1)
  
  res <- rep(NA_integer_, length(x))
  labels <- rep(NA_character_, n + 1)
  
  groups <- c(groups, Inf)
  res[is.infinite(x)] <- n + 1
  labels[n + 1] <- "Inf"
  
  for(idx in seq_len(n)){
    if(idx == n){
      labels[idx] <- paste0("[", sprintf(label_fmt, groups[idx]), ",", sprintf(label_fmt, groups[idx+1]), "]")
      res[x >= groups[idx] & x <= groups[idx+1]] <- idx
    }else{
      labels[idx] <- paste0("[", sprintf(label_fmt, groups[idx]), ",", sprintf(label_fmt, groups[idx+1]), ")")
      res[x >= groups[idx] & x < groups[idx+1]] <- idx
    }
  }
  if(add_label){
    factor(res, levels = seq_len(n + 1), labels = labels)
  }else{
    res
  }
}

bin.dists(seq(20, 10), n = 6, label_fmt = "%.f")
```

```{r}
# add Inf, n + 1 groups
# !! Values in groups need to be changed due to different value range
bin.dists2 <- function(x, groups, add_label = TRUE, label_fmt = "%.3f"){
  # groups <- seq(from, to, length.out = n+1)
  n <- length(groups) -1
  
  res <- rep(NA_integer_, length(x))
  labels <- rep(NA_character_, n + 1)
  
  groups <- c(groups, Inf)
  res[is.infinite(x)] <- n + 1
  labels[n + 1] <- "Inf"
  
  for(idx in seq_len(n)){
    if(idx == n){
      labels[idx] <- paste0("[", sprintf(label_fmt, groups[idx]), ",", sprintf(label_fmt, groups[idx+1]), "]")
      res[x >= groups[idx] & x <= groups[idx+1]] <- idx
    }else{
      labels[idx] <- paste0("[", sprintf(label_fmt, groups[idx]), ",", sprintf(label_fmt, groups[idx+1]), ")")
      res[x >= groups[idx] & x < groups[idx+1]] <- idx
    }
  }
  if(add_label){
    factor(res, levels = seq_len(n + 1), labels = labels)
  }else{
    res
  }
}

```

```{r}
groups <- c(0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.35,  0.6, 1.0)
spe$dist.cluster <- bin.dists2(spe$min.dists, groups = groups, label_fmt = "%.3f")
#spe$dist.cluster <- bin.dists(spe$min.dists, n = 10, label_fmt = "%.3f")

table(spe$dist.cluster)
```

```{r}
# Create the bar plot using ggplot2
plots <- as_tibble(spe$dist.cluster) %>% 
  ggplot(aes(x = value)) +
    geom_bar(fill = "skyblue") +
    theme_minimal() +
    labs(title = "Frequency of dists in each bin",
         x = "Bin",
         y = "Frequency") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

filename <- paste0("Bar plot of Frequency of dists in each bin", ".svg")
ggsave(filename = file.path(res.dir, "plots", filename), plot = plots, device = "svg", width = 10, height = 8)

filename <- paste0("Bar plot of Frequency of dists in each bin", ".png")
ggsave(filename = file.path(res.dir, "plots", filename), plot = plots, device = "png", width = 10, height = 8, dpi = 500)

plots
```

```{r}
set.seed(1)
logcounts(spe) <- transformGamPoi::shifted_log_transform(spe)
umap <- scater::calculateUMAP(spe)
reducedDim(spe, withDimnames = FALSE) <- umap

```

```{r}
set.seed(1)
# Remove inf
finite.mask <- is.finite(min.dists)
min.dists.finite <- min.dists[finite.mask]
spe.finite <- spe[, finite.mask]
spe.finite$dist.cluster <- droplevels(spe.finite$dist.cluster)
table(spe.finite$dist.cluster)

# subset genes
# spe.finite <- spe.finite[1:100, ]
dim(spe.finite)
fit <- lemur::lemur(spe.finite, design = ~ dist.cluster, n_embedding = 30, test_fraction = 0.6)

set.seed(1)
fit <- lemur::align_harmony(fit)
```

```{r}
table(spe.finite$dist.cluster)
bin.levels <- levels(spe.finite$dist.cluster)
idx.1 <- length(bin.levels) - 1
idx.2 <- 2

fit <- lemur::test_de(fit, cond(dist.cluster = bin.levels[idx.1]) - cond(dist.cluster = bin.levels[idx.2]))
set.seed(1)
DE <- assay(fit, "DE")
dim(DE)

nei <- lemur::find_de_neighborhoods(fit, group_by = vars(sample_id, dist.cluster), test_method = "none")
```

```{r}
res.dir.LEMUR <- file.path(get.res.dir(), "LEMUR")
if (!dir.exists(res.dir.LEMUR)) {
  dir.create(res.dir.LEMUR)
}

qs::qsave(spe, file.path(res.dir.LEMUR, "se_dist.qs"))
```

```{r}
# target gene CD19 THY1
target.genes <- c("CD19", "THY1", "NOC2L")
fit_small <- fit[target.genes,]
nei_small <- nei %>% filter(name %in% target.genes)

qs::qsave(fit_small, file.path(res.dir.LEMUR, "fit_small.qs"))
qs::qsave(nei_small, file.path(res.dir.LEMUR, "nei_small.qs"))

```

# Misc.

```{r}
bootstrap_sample <- function(data, indices) {
  sample_data <- data[indices, , drop = FALSE]
  return(sample_data)
}

# Sample data frame
data <- data.frame(
  orig = sample(c("A", "B", "C"), 100, replace = TRUE),
  dist.cluster = sample(1:3, 100, replace = TRUE),
  value = rnorm(100)
)
# Introducing some NA values
data$value[sample(1:100, 10)] <- NA

set.seed(123)  # For reproducibility

result <- data %>%
  group_by(orig, dist.cluster) %>%
  filter(!is.na(value)) %>%
  do({
    boot_result <- boot(.$value, statistic = function(x, i) x[i], R = 1000)
    data.frame(boot_result$t)
  }) %>%
  ungroup() %>%
  mutate(sample_id = row_number())

head(result)
dim(result)
```

```{r}
library(dplyr)
library(purrr)

# Example data (replace with your actual data)
set.seed(123)
df <- data.frame(
  orig = rep(c("A", "B"), each = 5),
  dist.cluster = rep(c("X", "Y"), each = 5),
  value = c(1, 2, NA, 4, 5, 6, 7, 8, NA, 10)
)

# Define a function to bootstrap sample each group
bootstrap_sample <- function(data) {
  # Exclude NAs for sampling
  data <- data[complete.cases(data), ]
  
  # Perform bootstrap sampling (example: simple random sampling with replacement)
  sampled_data <- data[sample(nrow(data), replace = TRUE), ]
  
  # Add back NA rows
  all_rows <- merge(data, sampled_data, all = TRUE)
  
  return(all_rows)
}

# Apply bootstrap sampling within each group
bootstrapped_data <- df %>%
  group_by(orig, dist.cluster) %>%
  group_modify(~ bootstrap_sample(.x)) %>%
  mutate(sample_id = row_number())

# View the result
bootstrapped_data

```

# Reference

-   Tutorial from Prof. Jean Fan, <https://jef.works/blog/2023/05/29/stdeconvolve-breast-cancer/>

-   STdeconvolve Vignettes, <https://www.bioconductor.org/packages/release/bioc/vignettes/STdeconvolve/inst/doc/vignette.html#spatialexperiment-inputs>
